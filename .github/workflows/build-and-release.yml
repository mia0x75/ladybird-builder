name: Build and Release Ladybird Browser

permissions:
  contents: write

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.1)"
        required: true
        type: string
  schedule:
    - cron: "0 0,12 * * *"

env:
  LADYBIRD_REPO: https://github.com/LadybirdBrowser/ladybird.git

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Clone Ladybird repository
        run: |
          git clone --depth 1 $LADYBIRD_REPO ladybird-src
          cd ladybird-src
          git submodule update --init --recursive

      - name: Install Ubuntu dependencies
        run: |
          sudo apt update
          sudo apt install -y autoconf autoconf-archive automake build-essential ccache cmake curl fonts-liberation2 git libdrm-dev libgl1-mesa-dev libtool nasm ninja-build pkg-config python3-venv qt6-base-dev qt6-tools-dev-tools qt6-wayland tar unzip zip libpulse-dev

      - name: Install CMake 3.25+
        run: |
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/kitware.list
          sudo apt update
          sudo apt install -y cmake

      - name: Setup GCC-14 compiler
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt update
          sudo apt install -y g++-14 libstdc++-14-dev

      - name: Build Ladybird
        working-directory: ladybird-src
        run: |
          ./Meta/ladybird.py build

      - name: Create Ubuntu tarball
        run: |
          cd ladybird-src/Build/release/bin
          tar -czf ../../../ladybird-ubuntu.tar.gz .
          cd ../../..

      - name: Upload Ubuntu artifact
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-ubuntu
          path: ladybird-src/ladybird-ubuntu.tar.gz
          retention-days: 7

  build-fedora:
    name: Build on Fedora
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Install Fedora dependencies
        run: |
          dnf update -y
          dnf install -y tree autoconf-archive automake ccache cmake curl git libdrm-devel liberation-sans-fonts libglvnd-devel libtool nasm ninja-build patchelf perl-FindBin perl-IPC-Cmd perl-lib perl-Time-Piece qt6-qtbase-devel qt6-qttools-devel qt6-qtwayland-devel tar unzip zip zlib-ng-compat-static pulseaudio-libs-devel shadow-utils sudo

      - name: Setup non-root user
        run: |
          useradd -m -u 1001 runner
          echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/runner

      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Clone Ladybird repository as non-root
        run: |
          su runner -c "git clone --depth 1 $LADYBIRD_REPO ladybird-src"
          su runner -c "cd ladybird-src && git submodule update --init --recursive"

      - name: Build Ladybird as non-root
        working-directory: ladybird-src
        run: |
          export CMAKE_ARGS="-DBUILD_TESTING=OFF"
          su runner -c "./Meta/ladybird.py build --preset Release Ladybird"

      - name: Create portable Ladybird bundle with runtime libraries
        working-directory: ladybird-src
        run: |
          # 创建分发目录
          su runner -c "mkdir -p dist/{bin,lib}"

          # 复制 Ladybird 及其必需的 helper 进程（排除 Test*）
          su runner -c "find Build/release/bin -maxdepth 1 -type f -executable \
                         ! -name 'Test*' ! -name 'CTest*' ! -name 'cmake*' \
                         -exec cp {} dist/bin/ \;"

          # 复制 vcpkg 动态库
          TRIPLET="x64-linux"
          VCPKG_LIB_DIR="Build/vcpkg/installed/ $ TRIPLET/lib"
          if [ ! -d " $ VCPKG_LIB_DIR" ]; then
            echo "Error: vcpkg lib dir not found"
            ls -la Build/vcpkg/installed/
            exit 1
          fi
          su runner -c "find  $ VCPKG_LIB_DIR -type f   $  -name '*.so' -o -name '*.so.*'  $   -exec cp {} dist/lib/ \;"

          # 设置 RPATH（对所有可执行文件）
          sudo dnf install -y patchelf
          su runner -c "for exe in dist/bin/*; do patchelf --set-rpath '\ $ ORIGIN/../lib' \"\ $ exe\"; done"

          # 打包
          su runner -c "tar -czf ladybird-fedora.tar.gz dist"
          ls -lah ladybird-fedora.tar.gz

      - name: Upload Fedora artifact
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-fedora
          path: ladybird-src/ladybird-fedora.tar.gz
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-ubuntu, build-fedora]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          # Move tarballs to root directory for release
          cp release-artifacts/ladybird-ubuntu/ladybird-ubuntu.tar.gz .
          cp release-artifacts/ladybird-fedora/ladybird-fedora.tar.gz .
          echo "=== Release files ready ==="
          ls -la *.tar.gz

      - name: Get current version
        id: current_version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || cat .github/version.txt 2>/dev/null || echo "v1.0.0")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Current latest tag: $LATEST_TAG"

      - name: Determine new version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            CURRENT_VERSION=${{ steps.current_version.outputs.LATEST_TAG }}
            VERSION_NUM=${CURRENT_VERSION#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "v${NEW_VERSION}" > .github/version.txt
          fi
          echo "Using version: ${{ steps.version.outputs.VERSION }}"

      - name: Create and push tag
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name != 'schedule'
        run: |
          NEW_VERSION="${{ steps.version.outputs.VERSION }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
            echo "Tag v${NEW_VERSION} already exists, skipping tag creation"
          else
            git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
            git push origin "v${NEW_VERSION}"
            echo "v${NEW_VERSION}" > .github/version.txt
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Ladybird Browser v${{ steps.version.outputs.VERSION }}
          body: |
            # Ladybird Browser v${{ steps.version.outputs.VERSION }}

            Automated build of Ladybird Browser

            ## Build Information:
            - Commit: ${{ github.sha }}
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Trigger: ${{ github.event_name }}

            ## Available Binaries:
            - **Ubuntu**: `ladybird-ubuntu.tar.gz` (GCC 14)
            - **Fedora**: `ladybird-fedora.tar.gz`

            ## Installation:
            1. Download the appropriate tarball for your distribution
            2. Extract: `tar -xzf ladybird-ubuntu.tar.gz`
            3. Run: `./Ladybird`

            **Note:** This is an automated build. For official releases, check the main Ladybird repository.
          draft: false
          prerelease: false
          files: |
            ladybird-ubuntu.tar.gz
            ladybird-fedora.tar.gz
